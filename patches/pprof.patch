commit 8de706de3434987430f5418f02dae48093f4aaea
Author: Yohei Ueda <yohei@jp.ibm.com>
Date:   Fri May 24 18:08:37 2019 +0900

    Support pprof block profiles
    
    Signed-off-by: Yohei Ueda <yohei@jp.ibm.com>

diff --git a/internal/peer/node/start.go b/internal/peer/node/start.go
index 0cf49df9d..c19ae7cb3 100644
--- a/internal/peer/node/start.go
+++ b/internal/peer/node/start.go
@@ -14,6 +14,7 @@ import (
 	"os/signal"
 	"path/filepath"
 	"syscall"
+	"runtime"
 	"time"
 
 	docker "github.com/fsouza/go-dockerclient"
@@ -539,6 +540,8 @@ func serve(args []string) error {
 
 	// Start profiling http endpoint if enabled
 	if profileEnabled {
+		runtime.SetBlockProfileRate(viper.GetInt("peer.profile.blockProfileRate"))
+		runtime.SetMutexProfileFraction(viper.GetInt("peer.profile.mutexProfileFraction"))
 		go func() {
 			logger.Infof("Starting profiling server with listenAddress = %s", profileListenAddress)
 			if profileErr := http.ListenAndServe(profileListenAddress, nil); profileErr != nil {
diff --git a/orderer/common/localconfig/config.go b/orderer/common/localconfig/config.go
index e33347842..cf5af7743 100644
--- a/orderer/common/localconfig/config.go
+++ b/orderer/common/localconfig/config.go
@@ -108,8 +108,10 @@ type Authentication struct {
 
 // Profile contains configuration for Go pprof profiling.
 type Profile struct {
-	Enabled bool
-	Address string
+	Enabled              bool
+	Address              string
+	BlockProfileRate     int
+	MutexProfileFraction int
 }
 
 // FileLedger contains configuration for the file-based ledger.
@@ -218,8 +220,10 @@ var Defaults = TopLevel{
 		SystemChannel:  "test-system-channel-name",
 		GenesisFile:    "genesisblock",
 		Profile: Profile{
-			Enabled: false,
-			Address: "0.0.0.0:6060",
+			Enabled:              false,
+			Address:              "0.0.0.0:6060",
+			BlockProfileRate:     0,
+			MutexProfileFraction: 0,
 		},
 		Cluster: Cluster{
 			ReplicationMaxRetries:                12,
diff --git a/orderer/common/server/main.go b/orderer/common/server/main.go
index 62f538de1..f594a93b3 100644
--- a/orderer/common/server/main.go
+++ b/orderer/common/server/main.go
@@ -16,6 +16,7 @@ import (
 	_ "net/http/pprof" // This is essentially the main package for the orderer
 	"os"
 	"os/signal"
+	"runtime"
 	"sync"
 	"syscall"
 	"time"
@@ -248,6 +249,9 @@ func initializeLogging() {
 // Start the profiling service if enabled.
 func initializeProfilingService(conf *localconfig.TopLevel) {
 	if conf.General.Profile.Enabled {
+		runtime.SetBlockProfileRate(conf.General.Profile.BlockProfileRate)
+		runtime.SetMutexProfileFraction(conf.General.Profile.MutexProfileFraction)
+
 		go func() {
 			logger.Info("Starting Go pprof profiling service on:", conf.General.Profile.Address)
 			// The ListenAndServe() call does not return unless an error occurs.
diff --git a/sampleconfig/core.yaml b/sampleconfig/core.yaml
index 60785ebcb..2f20cbeb2 100644
--- a/sampleconfig/core.yaml
+++ b/sampleconfig/core.yaml
@@ -337,6 +337,8 @@ peer:
     profile:
         enabled:     false
         listenAddress: 0.0.0.0:6060
+        blockProfileRate: 0
+        mutexProfileFraction: 0
 
     # The admin service is used for administrative operations such as
     # control over logger levels, etc.
diff --git a/sampleconfig/orderer.yaml b/sampleconfig/orderer.yaml
index 36588286b..6cf8323dd 100644
--- a/sampleconfig/orderer.yaml
+++ b/sampleconfig/orderer.yaml
@@ -112,6 +112,8 @@ General:
     Profile:
         Enabled: false
         Address: 0.0.0.0:6060
+        BlockProfileRate: 0
+        MutexProfileFraction: 0
 
     # BCCSP configures the blockchain crypto service providers.
     BCCSP:
